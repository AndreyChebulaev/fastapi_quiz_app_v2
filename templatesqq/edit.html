{% extends "base.html" %}

{% block content %}
<h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤</h2>
<form method="post" id="main-form">
    <input type="hidden" name="filename" value="{{ filename }}">
    
    <div class="file-info">
        <h3>üìÑ –§–∞–π–ª: {{ filename }}</h3>
        <p style="margin: 0; color: #666;">–§–æ—Ä–º–∞—Ç: Excel (.xlsx) - 1-–π —Å—Ç–æ–ª–±–µ—Ü: –≤–æ–ø—Ä–æ—Å, 2-–π —Å—Ç–æ–ª–±–µ—Ü: –æ—Ç–≤–µ—Ç—ã –≤ –∫–∞–≤—ã—á–∫–∞—Ö</p>
    </div>
    
    <div id="questions-container">
        {% for question in questions %}
        <div class="question-block" data-index="{{ loop.index0 }}">
            <div class="question-header">
                <h3>‚ùì –í–æ–ø—Ä–æ—Å {{ loop.index }}</h3>
                <button type="button" class="btn-remove-question" onclick="removeQuestion({{ loop.index0 }})">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å
                </button>
            </div>
            
            <div class="form-group">
                <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
                <textarea 
                    name="questions" 
                    class="question-textarea"
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞..." 
                    required
                    rows="3">{{ question.question }}</textarea>
            </div>
            
            <div class="form-group">
                <label>üìù –û—Ç–≤–µ—Ç—ã (–∫–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ):</label>
                <div class="answers-container" id="answers-{{ loop.index0 }}">
                    {% for answer in question.answers %}
                    <div class="answer-row">
                        <textarea 
                            class="answer-textarea"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞..."
                            rows="2">{{ answer }}</textarea>
                        <button type="button" class="btn-remove-answer" onclick="removeAnswer(this)">√ó</button>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn-add-answer" onclick="addAnswer({{ loop.index0 }})">
                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <div class="actions">
        <button type="button" onclick="addQuestion()" class="btn-add-question">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å
        </button>
        <button type="submit" class="btn-save" style="background: linear-gradient(135deg, #27ae60, #219a52);">
            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Excel
        </button>
        <a href="/select" class="btn-cancel">
            ‚ùå –û—Ç–º–µ–Ω–∞
        </a>
    </div>
</form>

<script>
let questionCount = {{ questions | length }};

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
function addQuestion() {
    const container = document.getElementById('questions-container');
    const newIndex = questionCount;
    
    const newQuestion = document.createElement('div');
    newQuestion.className = 'question-block';
    newQuestion.setAttribute('data-index', newIndex);
    newQuestion.innerHTML = `
        <div class="question-header">
            <h3>‚ùì –í–æ–ø—Ä–æ—Å ${newIndex + 1}</h3>
            <button type="button" class="btn-remove-question" onclick="removeQuestion(${newIndex})">
                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å
            </button>
        </div>
        
        <div class="form-group">
            <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
            <textarea name="questions" 
                   class="question-textarea"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞..." 
                   required
                   rows="3"></textarea>
        </div>
        
        <div class="form-group">
            <label>üìù –û—Ç–≤–µ—Ç—ã (–∫–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ):</label>
            <div class="answers-container" id="answers-${newIndex}">
                <div class="answer-row">
                    <textarea class="answer-textarea"
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞..."
                           rows="2"></textarea>
                    <button type="button" class="btn-remove-answer" onclick="removeAnswer(this)">√ó</button>
                </div>
            </div>
            <button type="button" class="btn-add-answer" onclick="addAnswer(${newIndex})">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
            </button>
        </div>
    `;
    container.appendChild(newQuestion);
    questionCount++;
    updateQuestionNumbers();
}

// –£–¥–∞–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞
function removeQuestion(index) {
    const questionBlock = document.querySelector(`.question-block[data-index="${index}"]`);
    if (questionBlock && document.querySelectorAll('.question-block').length > 1) {
        questionBlock.remove();
        updateQuestionNumbers();
    } else if (document.querySelectorAll('.question-block').length === 1) {
        alert('–î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å!');
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤
function updateQuestionNumbers() {
    const questionBlocks = document.querySelectorAll('.question-block');
    questionBlocks.forEach((block, index) => {
        const header = block.querySelector('.question-header h3');
        header.textContent = `‚ùì –í–æ–ø—Ä–æ—Å ${index + 1}`;
        block.setAttribute('data-index', index);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        const removeBtn = block.querySelector('.btn-remove-question');
        removeBtn.setAttribute('onclick', `removeQuestion(${index})`);
        
        const addAnswerBtn = block.querySelector('.btn-add-answer');
        addAnswerBtn.setAttribute('onclick', `addAnswer(${index})`);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –æ—Ç–≤–µ—Ç–æ–≤
        const answersContainer = block.querySelector('.answers-container');
        answersContainer.id = `answers-${index}`;
    });
    questionCount = questionBlocks.length;
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
function addAnswer(questionIndex) {
    const answersContainer = document.getElementById(`answers-${questionIndex}`);
    const answerRow = document.createElement('div');
    answerRow.className = 'answer-row';
    answerRow.innerHTML = `
        <textarea class="answer-textarea"
               placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞..."
               rows="2"></textarea>
        <button type="button" class="btn-remove-answer" onclick="removeAnswer(this)">√ó</button>
    `;
    answersContainer.appendChild(answerRow);
}

// –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
function removeAnswer(button) {
    const answerRow = button.parentElement;
    const answersContainer = answerRow.parentElement;
    if (answersContainer.querySelectorAll('.answer-row').length > 1) {
        answerRow.remove();
    } else {
        alert('–î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç!');
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
document.getElementById('main-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    const formData = new FormData();
    formData.append('filename', document.querySelector('input[name="filename"]').value);
    
    const questionBlocks = document.querySelectorAll('.question-block');
    const questions = [];
    const answers = [];
    
    questionBlocks.forEach((block) => {
        // –í–æ–ø—Ä–æ—Å
        const questionTextarea = block.querySelector('.question-textarea');
        questions.push(questionTextarea.value.trim());
        
        // –û—Ç–≤–µ—Ç—ã
        const answerTextareas = block.querySelectorAll('.answer-textarea');
        const answersArray = Array.from(answerTextareas)
            .map(textarea => textarea.value.trim())
            .filter(val => val);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ JSON –º–∞—Å—Å–∏–≤
        answers.push(JSON.stringify(answersArray));
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã –≤ formData
    questions.forEach(q => formData.append('questions', q));
    answers.forEach(a => formData.append('answers', a));
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const submitBtn = this.querySelector('.btn-save');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Excel...';
    submitBtn.disabled = true;
    
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const response = await fetch('/save_edit', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ ' + result.message);
            // –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
            // window.location.href = '/select';
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + result.error);
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});
</script>

<style>
.question-block {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.question-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #007bff;
}

.question-header h3 {
    margin: 0;
    color: #007bff;
}

.btn-remove-question {
    background: #dc3545;
    color: white;
    border: none;
    padding: 5px 15px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.btn-remove-question:hover {
    background: #c82333;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #495057;
}

.question-textarea,
.answer-textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
    resize: vertical;
}

.question-textarea:focus,
.answer-textarea:focus {
    outline: none;
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

.answer-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    align-items: flex-start;
}

.answer-row textarea {
    flex: 1;
}

.btn-remove-answer {
    background: #6c757d;
    color: white;
    border: none;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-remove-answer:hover {
    background: #5a6268;
}

.btn-add-answer {
    background: #17a2b8;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.btn-add-answer:hover {
    background: #138496;
}

.actions {
    display: flex;
    gap: 10px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 2px solid #dee2e6;
}

.btn-add-question {
    background: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
}

.btn-add-question:hover {
    background: #0069d9;
}

.btn-save {
    background: linear-gradient(135deg, #27ae60, #219a52);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
}

.btn-save:hover {
    background: linear-gradient(135deg, #219a52, #1e8749);
}

.btn-cancel {
    background: #e74c3c;
    color: white;
    padding: 10px 20px;
    text-decoration: none;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.btn-cancel:hover {
    background: #c0392b;
    color: white;
    text-decoration: none;
}

.file-info {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    padding: 15px;
    margin-bottom: 25px;
    border-radius: 0 4px 4px 0;
}

.file-info h3 {
    margin-top: 0;
    color: #1976d2;
}
</style>
{% endblock %}