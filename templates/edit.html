{% extends "base.html" %}

{% block content %}
<h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤</h2>
<form action="/main2/save" method="post" id="main-form">
    <input type="hidden" name="filename" value="{{ filename }}">
    <input type="hidden" name="original_data" value="{{ original_data }}">
    
    <div class="file-info">
        <h3>üìÑ –§–∞–π–ª: {{ filename }}</h3>
        <p style="margin: 0; color: #666;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –æ—Ç–≤–µ—Ç–∞–º–∏</p>
    </div>
    
    <div id="questions-container">
        {% for question in questions %}
        <div class="question-block" data-index="{{ loop.index0 }}">
            <div class="question-header">
                <h3>‚ùì –í–æ–ø—Ä–æ—Å {{ loop.index }}</h3>
                <button type="button" class="btn-remove-question" onclick="removeQuestion({{ loop.index0 }})">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å
                </button>
            </div>
            
            <div class="form-group">
                <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
                <input type="text" name="questions" value="{{ question.question }}" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞..." required
                       style="padding: 15px; font-size: 15px;">
            </div>
            
            <div class="form-group">
                <label>üìù –û—Ç–≤–µ—Ç—ã:</label>
                <div class="answers-container" id="answers-{{ loop.index0 }}">
                    {% for answer in question.answers %}
                    <div class="answer-row">
                        <input type="text" class="answer-input" value="{{ answer }}" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞..."
                               style="padding: 12px;">
                        <button type="button" class="btn-remove-answer" onclick="removeAnswer(this)">√ó</button>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn-add-answer" onclick="addAnswer({{ loop.index0 }})">
                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <div class="actions">
        <button type="button" onclick="addQuestion()">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å
        </button>
        <button type="submit" style="background: linear-gradient(135deg, #27ae60, #219a52);">
            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        </button>
        <button type="button" onclick="location.href='/select'" style="background: linear-gradient(135deg, #7f8c8d, #6c7a89);">
            üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
        </button>
    </div>
</form>

<script>
let questionCount = {{ questions | length }};

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
function addQuestion() {
    const container = document.getElementById('questions-container');
    const newIndex = questionCount;
    
    const newQuestion = document.createElement('div');
    newQuestion.className = 'question-block';
    newQuestion.setAttribute('data-index', newIndex);
    newQuestion.innerHTML = `
        <div class="question-header">
            <h3>‚ùì –í–æ–ø—Ä–æ—Å ${newIndex + 1}</h3>
            <button type="button" class="btn-remove-question" onclick="removeQuestion(${newIndex})">
                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å
            </button>
        </div>
        
        <div class="form-group">
            <label>–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
            <input type="text" name="questions" value="" 
                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞..." required
                   style="padding: 15px; font-size: 15px;">
        </div>
        
        <div class="form-group">
            <label>üìù –û—Ç–≤–µ—Ç—ã:</label>
            <div class="answers-container" id="answers-${newIndex}">
                <div class="answer-row">
                    <input type="text" class="answer-input" value="" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞..."
                           style="padding: 12px;">
                    <button type="button" class="btn-remove-answer" onclick="removeAnswer(this)">√ó</button>
                </div>
            </div>
            <button type="button" class="btn-add-answer" onclick="addAnswer(${newIndex})">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
            </button>
        </div>
    `;
    container.appendChild(newQuestion);
    questionCount++;
    updateQuestionNumbers();
}

// –£–¥–∞–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞
function removeQuestion(index) {
    const questionBlock = document.querySelector(`.question-block[data-index="${index}"]`);
    if (questionBlock && document.querySelectorAll('.question-block').length > 1) {
        questionBlock.remove();
        updateQuestionNumbers();
    } else if (document.querySelectorAll('.question-block').length === 1) {
        alert('–î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å!');
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤
function updateQuestionNumbers() {
    const questionBlocks = document.querySelectorAll('.question-block');
    questionBlocks.forEach((block, index) => {
        const header = block.querySelector('.question-header h3');
        header.textContent = `‚ùì –í–æ–ø—Ä–æ—Å ${index + 1}`;
        block.setAttribute('data-index', index);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        const removeBtn = block.querySelector('.btn-remove-question');
        removeBtn.setAttribute('onclick', `removeQuestion(${index})`);
        
        const addAnswerBtn = block.querySelector('.btn-add-answer');
        addAnswerBtn.setAttribute('onclick', `addAnswer(${index})`);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –æ—Ç–≤–µ—Ç–æ–≤
        const answersContainer = block.querySelector('.answers-container');
        answersContainer.id = `answers-${index}`;
    });
    questionCount = questionBlocks.length;
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
function addAnswer(questionIndex) {
    const answersContainer = document.getElementById(`answers-${questionIndex}`);
    const answerRow = document.createElement('div');
    answerRow.className = 'answer-row';
    answerRow.innerHTML = `
        <input type="text" class="answer-input" value="" 
               placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞..."
               style="padding: 12px;">
        <button type="button" class="btn-remove-answer" onclick="removeAnswer(this)">√ó</button>
    `;
    answersContainer.appendChild(answerRow);
}

// –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
function removeAnswer(button) {
    const answerRow = button.parentElement;
    const answersContainer = answerRow.parentElement;
    if (answersContainer.querySelectorAll('.answer-row').length > 1) {
        answerRow.remove();
    } else {
        alert('–î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç!');
    }
}

// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã
document.getElementById('main-form').addEventListener('submit', function(e) {
    e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
    
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –æ—Ç–≤–µ—Ç—ã –≤ —Å—Ç—Ä–æ–∫–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–∞–≤—ã—á–µ–∫
    const questionBlocks = document.querySelectorAll('.question-block');
    
    // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    const formData = new FormData();
    formData.append('filename', document.querySelector('input[name="filename"]').value);
    formData.append('original_data', document.querySelector('input[name="original_data"]').value);
    
    questionBlocks.forEach((block, index) => {
        const questionInput = block.querySelector('input[name="questions"]');
        const questionText = questionInput.value;
        
        const answerInputs = block.querySelectorAll('.answer-input');
        const answersArray = Array.from(answerInputs).map(input => input.value.trim()).filter(val => val);
        
        // –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç—ã —Å –∫–∞–≤—ã—á–∫–∞–º–∏
        const answersString = answersArray.map(answer => `"${answer}"`).join(',');
        
        formData.append('questions', questionText);
        formData.append('answers', JSON.stringify(answersArray));
    });
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ fetch
    fetch('/main2/save_edit', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
            window.location.href = '/select';
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message);
    });
});
</script>
{% endblock %}